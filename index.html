<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MWI Upgrade Cost Calculator</title>

  <!-- Terminal font -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020617;
      --panel:#000;
      --border:rgba(34,197,94,.35);
      --border2:rgba(34,197,94,.2);
      --text:#86efac;
      --muted:#4ade80;
      --accent:#22c55e;
      --shadow:rgba(34,197,94,.25);

      --danger-bg:#3f1d1d;
      --danger-border:#7f1d1d;
      --danger-text:#fecaca;

      --coin:#fbbf24;
      --lumber:#22c55e;
      --log:#34d399;
      --arcane:#a78bfa;
      --ore:#93c5fd;
      --herb:#bef264;
      --food:#fb7185;
      --generic:#86efac;
    }

    *{ box-sizing:border-box; }

    body{
      font-family:"JetBrains Mono", monospace;
      background: radial-gradient(circle at top, #020617, #000);
      color:var(--text);
      margin:24px;
      max-width:980px;
    }

    /* Subtle CRT scanlines */
    body::after{
      content:"";
      pointer-events:none;
      position:fixed;
      inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.03),
        rgba(255,255,255,.03) 1px,
        transparent 1px,
        transparent 3px
      );
      opacity:.06;
    }

    h1{
      margin:0 0 10px;
      color:var(--accent);
      font-weight:600;
      text-shadow:0 0 10px var(--shadow);
      display:flex;
      align-items:center;
      gap:8px;
    }

    .cursor{
      display:inline-block;
      width:10px;
      color:var(--accent);
      animation: blink 1s steps(1) infinite;
      text-shadow:0 0 10px var(--shadow);
    }
    @keyframes blink{ 50%{ opacity:0; } }

    .muted{ color:var(--muted); font-size:12px; }

    .card{
      background: linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.6));
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      margin-top:14px;
      box-shadow: inset 0 0 0 1px rgba(34,197,94,.08), 0 0 18px rgba(34,197,94,.06);
    }

    .row{
      display:grid;
      gap:12px;
      grid-template-columns: 1.5fr 1fr 1fr;
      align-items:end;
    }

    label{
      display:block;
      font-size:12px;
      margin-bottom:6px;
      color:var(--muted);
    }

    select, input{
      width:100%;
      padding:10px;
      font-family:inherit;
      font-size:13px;
      background:var(--panel);
      color:var(--text);
      border:1px solid var(--border2);
      border-radius:10px;
      outline:none;
    }
    select:focus, input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(34,197,94,.35);
    }

    button{
      padding:10px 14px;
      font-family:inherit;
      font-size:13px;
      border-radius:10px;
      border:1px solid var(--border2);
      background:var(--panel);
      color:var(--accent);
      cursor:pointer;
    }
    button:hover{
      background:rgba(34,197,94,.08);
      box-shadow:0 0 10px rgba(34,197,94,.22);
    }
    .btn{
      border-color:var(--accent);
      color:#000;
      background:var(--accent);
      font-weight:600;
    }
    .btn:hover{ background:#16a34a; }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(34,197,94,.15);
      color:var(--accent);
      font-size:11px;
    }

    .error{
      background:var(--danger-bg);
      border:1px solid var(--danger-border);
      color:var(--danger-text);
      padding:10px;
      border-radius:12px;
      margin-top:12px;
      font-size:13px;
    }

    .promptTitle{
      margin:18px 0 8px;
      color:var(--accent);
      font-weight:600;
      text-shadow:0 0 10px rgba(34,197,94,.25);
    }
    .promptTitle::before{
      content:"> ";
      color:var(--muted);
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th, td{
      padding:10px;
      border-bottom:1px dashed rgba(34,197,94,.22);
    }
    th{
      color:var(--muted);
      font-weight:600;
    }
    .right{ text-align:right; }

    .total{
      font-size:18px;
      font-weight:600;
      color:var(--accent);
      display:flex;
      justify-content:space-between;
      margin-top:10px;
      text-shadow:0 0 10px rgba(34,197,94,.35);
    }

    details summary{
      cursor:pointer;
      color:var(--accent);
      list-style:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    details summary::before{
      content:"> ";
      color:var(--muted);
    }
    details[open] summary .chev{ transform:rotate(90deg); }
    .chev{
      display:inline-block;
      margin-right:6px;
      transition: transform .15s ease;
    }

    /* Resource color coding */
    .res-coin{ color:var(--coin); text-shadow:0 0 10px rgba(251,191,36,.18); }
    .res-lumber{ color:var(--lumber); }
    .res-log{ color:var(--log); }
    .res-arcane{ color:var(--arcane); text-shadow:0 0 10px rgba(167,139,250,.18); }
    .res-ore{ color:var(--ore); }
    .res-herb{ color:var(--herb); }
    .res-food{ color:var(--food); }
    .res-generic{ color:var(--generic); }

    /* Summary output box */
    .output{
      width:100%;
      min-height:120px;
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border2);
      background:#000;
      color:var(--text);
      font-family:inherit;
      font-size:12px;
      resize:vertical;
    }

    .hintRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
    }

    .kbd{
      border:1px solid rgba(34,197,94,.25);
      padding:2px 6px;
      border-radius:8px;
      color:var(--muted);
      font-size:11px;
      background:rgba(34,197,94,.06);
    }
  </style>
</head>

<body>
  <h1>MWI Upgrade Cost Calculator <span class="cursor">▊</span></h1>
  <div class="muted">Choose a building tab, then pick current + target level. We sum only the levels you still need.</div>

  <div class="card">
    <div class="row">
      <div>
        <label for="sheet">Building / Tab</label>
        <select id="sheet"></select>
      </div>
      <div>
        <label for="currentLevel">Current Level</label>
        <input id="currentLevel" type="number" min="0" value="0" />
      </div>
      <div>
        <label for="targetLevel">Target Level</label>
        <input id="targetLevel" type="number" min="1" value="1" />
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:12px; align-items:center;">
      <button class="btn" id="calcBtn">Calculate</button>
      <button id="reloadBtn">Reload Tab Data</button>
      <span class="muted" id="status"></span>
    </div>

    <div id="err" class="error" style="display:none;"></div>
  </div>

  <div class="card" id="results" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div class="muted">Selected Range</div>
        <div id="rangeText" style="font-weight:600;"></div>
      </div>
      <div class="pill" id="rowsText"></div>
    </div>

    <div class="total">
      <div>Grand Total (numeric sums)</div>
      <div id="grandTotal">—</div>
    </div>

    <div class="promptTitle">Terminal Output</div>
    <div class="hintRow">
      <div class="muted">
        Shortcuts:
        <span class="kbd">Enter</span> calculate
        <span class="kbd">Ctrl+K</span> focus building
        <span class="kbd">Ctrl+Enter</span> copy summary
      </div>
      <button id="copyBtn">Copy Summary</button>
    </div>
    <textarea id="summaryOut" class="output" readonly></textarea>

    <div class="promptTitle">Breakdown by Resource</div>
    <table>
      <thead>
        <tr>
          <th>Resource</th>
          <th class="right">Total Amount</th>
        </tr>
      </thead>
      <tbody id="resourceRows"></tbody>
    </table>

    <details id="lineItemsDetails">
      <summary style="margin:18px 0 8px; font-weight:600;">
        <span class="chev">▶</span>
        Line Items <span class="muted" id="lineItemsHint"></span>
      </summary>

      <table>
        <thead>
          <tr>
            <th>Level</th>
            <th>Resource</th>
            <th class="right">Amount</th>
          </tr>
        </thead>
        <tbody id="lineRows"></tbody>
      </table>
    </details>
  </div>

<script>
  // Your sheet ID (from your link)
  const SHEET_ID = "16Dcwa4OSYKn7emoca1aqoS-RGo_SeJEPHS2_yfC9iFs";

  // Tab names (add/remove as needed)
  const SHEETS = [
    "Skilling - Log Shed",
    "Skilling - Dairy Barn",
    "Skilling - Garden",
    "Skilling - Forge",
    "Skilling - Workshop",
    "Skilling - Sewing Parlor",
    "Skilling - Kitchen",
    "Skilling - Brewery",
    "Skilling - Laboratory",
    "Skilling - Observatory",
    "Combat - Dining Room",
    "Combat - Library",
    "Combat - Dojo",
    "Combat - Gym",
    "Combat - Armory",
    "Combat - Archery Range",
    "Combat - Mystical Study",
  ];

  const els = {
    sheet: document.getElementById("sheet"),
    currentLevel: document.getElementById("currentLevel"),
    targetLevel: document.getElementById("targetLevel"),
    calcBtn: document.getElementById("calcBtn"),
    reloadBtn: document.getElementById("reloadBtn"),
    status: document.getElementById("status"),
    err: document.getElementById("err"),
    results: document.getElementById("results"),
    rangeText: document.getElementById("rangeText"),
    rowsText: document.getElementById("rowsText"),
    grandTotal: document.getElementById("grandTotal"),
    resourceRows: document.getElementById("resourceRows"),
    lineRows: document.getElementById("lineRows"),
    copyBtn: document.getElementById("copyBtn"),
    summaryOut: document.getElementById("summaryOut"),
    lineItemsDetails: document.getElementById("lineItemsDetails"),
    lineItemsHint: document.getElementById("lineItemsHint"),
  };

  // Loaded tab data:
  // levels[levelNumber] = [{ amount:number, resource:string }, ...]
  let loaded = { sheetName: null, maxLevel: 0, levels: {} };

  function setStatus(msg) { els.status.textContent = msg || ""; }
  function showError(msg) { els.err.style.display = "block"; els.err.textContent = msg; }
  function clearError() { els.err.style.display = "none"; els.err.textContent = ""; }

  function formatNumber(n) {
    return n.toLocaleString(undefined, { maximumFractionDigits: 0 });
  }

  // Fetch tab via Google Visualization (no API key required for public/viewable sheets)
  function gvizUrl(sheetName) {
    const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
    const params = new URLSearchParams({
      tqx: "out:json",
      sheet: sheetName
    });
    return `${base}?${params.toString()}`;
  }

  function parseGvizJson(text) {
    // Response looks like: google.visualization.Query.setResponse({...});
    const start = text.indexOf("{");
    const end = text.lastIndexOf("}");
    if (start === -1 || end === -1) throw new Error("Unexpected gviz response.");
    return JSON.parse(text.slice(start, end + 1));
  }

  function toCellString(cell) {
    // cell can be null or {v:..., f:...}
    if (!cell) return "";
    if (cell.f != null) return String(cell.f);
    if (cell.v != null) return String(cell.v);
    return "";
  }

  function resourceClass(resourceName) {
    const r = String(resourceName || "").toLowerCase();
    if (r.includes("coin")) return "res-coin";
    if (r.includes("lumber")) return "res-lumber";
    if (r.includes("log")) return "res-log";
    if (r.includes("arcane")) return "res-arcane";
    if (r.includes("ore") || r.includes("bar") || r.includes("ingot")) return "res-ore";
    if (r.includes("herb") || r.includes("leaf") || r.includes("root")) return "res-herb";
    if (r.includes("bread") || r.includes("cheese") || r.includes("stew") || r.includes("meal")) return "res-food";
    return "res-generic";
  }

  function buildSummaryText({ sheetName, fromLevel, toLevel, current, items, byResource, grand }) {
    const lines = [];
    lines.push(`> ${sheetName}`);
    lines.push(`> Range: L${fromLevel} -> L${toLevel} (current: L${current})`);
    lines.push(`> Items: ${items.length}`);
    lines.push(`> ------------------------------`);
    lines.push(`> Breakdown:`);

    const sorted = [...byResource.entries()].sort((a,b) => b[1]-a[1]);
    for (const [res, total] of sorted) {
      lines.push(`  - ${res}: ${formatNumber(total)}`);
    }

    lines.push(`> ------------------------------`);
    lines.push(`> Grand Total: ${formatNumber(grand)}`);
    lines.push(`>`);
    lines.push(`> Line Items:`);

    for (const it of items) {
      const res = String(it.resource);
      lines.push(`  L${it.level}  ${res.padEnd(22, " ")}  ${formatNumber(it.amount)}`);
    }

    return lines.join("\n");
  }

  async function copyToClipboard(text) {
    await navigator.clipboard.writeText(text);
  }

  async function loadTab(sheetName) {
    clearError();
    setStatus(`Loading "${sheetName}"…`);

    const res = await fetch(gvizUrl(sheetName), { cache: "no-store" });
    if (!res.ok) throw new Error(`Failed to fetch "${sheetName}". (Is the tab name correct?)`);
    const raw = await res.text();
    const json = parseGvizJson(raw);

    const table = json.table;
    if (!table || !table.cols || !table.rows) throw new Error(`No table data returned for "${sheetName}".`);

    // ✅ Each column = one level (Level 1..Level 8)
    const colCount = table.cols.length;
    const maxLevel = colCount;

    const levels = {};
    for (let lvl = 1; lvl <= maxLevel; lvl++) levels[lvl] = [];

    // Helper: parse a cell like "500,000 Coin" or "-9 Cheese Hatchet" or "-"
    function parseCellToItem(cellText) {
      const s = String(cellText || "").trim();
      if (!s || s === "-" || s === "—") return null;

      // match leading number (supports commas + negatives)
      const m = s.match(/^(-?\d[\d,]*)(?:\s+(.+))?$/);
      if (!m) return null;

      const amount = Number(m[1].replace(/,/g, ""));
      if (!Number.isFinite(amount)) return null;

      const resource = (m[2] || "").trim();
      if (!resource) return null;

      return { amount, resource };
    }

    // Each row has N cells (one per level column)
    for (const r of table.rows) {
      const c = r.c || [];
      for (let lvl = 1; lvl <= maxLevel; lvl++) {
        const cellText = toCellString(c[lvl - 1]);
        const item = parseCellToItem(cellText);
        if (!item) continue;
        levels[lvl].push(item);
      }
    }

    loaded = { sheetName, maxLevel, levels };
    setStatus(`Loaded "${sheetName}" (max level: ${maxLevel}).`);

    // Clamp inputs to max level
    const cur = Number(els.currentLevel.value) || 0;
    const tgt = Number(els.targetLevel.value) || 1;
    if (tgt > maxLevel) els.targetLevel.value = String(maxLevel);
    if (cur > maxLevel) els.currentLevel.value = String(maxLevel);
  }

  function calculate() {
    clearError();

    if (!loaded.sheetName) return showError("Load a tab first.");

    const current = Number(els.currentLevel.value);
    const target = Number(els.targetLevel.value);

    if (!Number.isFinite(current) || current < 0) return showError("Current level must be 0 or higher.");
    if (!Number.isFinite(target) || target < 1) return showError("Target level must be 1 or higher.");
    if (target <= current) return showError("Target level must be higher than current level.");
    if (target > loaded.maxLevel) return showError(`Target level can't exceed ${loaded.maxLevel} for this tab.`);

    const fromLevel = current + 1;
    const toLevel = target;

    const items = [];
    for (let lvl = fromLevel; lvl <= toLevel; lvl++) {
      for (const it of (loaded.levels[lvl] || [])) {
        items.push({ level: lvl, amount: it.amount, resource: it.resource });
      }
    }

    if (items.length === 0) return showError(`No items found for levels ${fromLevel}-${toLevel}.`);

    // Breakdown
    const byResource = new Map();
    let grand = 0;

    for (const it of items) {
      grand += it.amount;
      byResource.set(it.resource, (byResource.get(it.resource) || 0) + it.amount);
    }

    // Render
    els.results.style.display = "block";
    els.rangeText.textContent = `${loaded.sheetName} — Levels ${fromLevel} → ${toLevel} (current: ${current})`;
    els.rowsText.textContent = `${items.length} line item(s)`;
    els.grandTotal.textContent = formatNumber(grand);
    els.lineItemsHint.textContent = `(${items.length})`;

    // Breakdown table (colored resources)
    els.resourceRows.innerHTML = "";
    [...byResource.entries()]
      .sort((a,b) => b[1] - a[1])
      .forEach(([resource, total]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><span class="${resourceClass(resource)}">${resource}</span></td><td class="right">${formatNumber(total)}</td>`;
        els.resourceRows.appendChild(tr);
      });

    // Line items (colored resources)
    els.lineRows.innerHTML = "";
    items.forEach((it) => {
      const tr = document.createElement("tr");
      tr.innerHTML =
        `<td>${it.level}</td>
         <td><span class="${resourceClass(it.resource)}">${it.resource}</span></td>
         <td class="right">${formatNumber(it.amount)}</td>`;
      els.lineRows.appendChild(tr);
    });

    // Terminal output
    els.summaryOut.value = buildSummaryText({
      sheetName: loaded.sheetName,
      fromLevel,
      toLevel,
      current,
      items,
      byResource,
      grand
    });
  }

  function initSheetSelect() {
    els.sheet.innerHTML = "";
    SHEETS.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      els.sheet.appendChild(opt);
    });
  }

  els.reloadBtn.addEventListener("click", async () => {
    try { await loadTab(els.sheet.value); }
    catch (e) { setStatus(""); showError(e.message || String(e)); }
  });

  els.calcBtn.addEventListener("click", calculate);

  els.copyBtn?.addEventListener("click", async () => {
    try {
      await copyToClipboard(els.summaryOut.value || "");
      setStatus("Copied summary to clipboard.");
      setTimeout(() => setStatus(""), 1200);
    } catch (e) {
      showError("Copy failed. Your browser may be blocking clipboard access.");
    }
  });

  // Keyboard shortcuts:
  // Enter = calculate (unless focused in textarea)
  // Ctrl+K = focus building dropdown
  // Ctrl+Enter = copy summary
  document.addEventListener("keydown", async (e) => {
    const key = e.key.toLowerCase();

    if (e.ctrlKey && key === "k") {
      e.preventDefault();
      els.sheet.focus();
      return;
    }

    if (!e.ctrlKey && e.key === "Enter") {
      if (document.activeElement && document.activeElement.tagName === "TEXTAREA") return;
      e.preventDefault();
      calculate();
      return;
    }

    if (e.ctrlKey && e.key === "Enter") {
      e.preventDefault();
      try {
        await copyToClipboard(els.summaryOut.value || "");
        setStatus("Copied summary to clipboard.");
        setTimeout(() => setStatus(""), 1200);
      } catch (err) {
        showError("Copy failed. Your browser may be blocking clipboard access.");
      }
    }
  });

  // Initialize
  (async function boot() {
    initSheetSelect();
    try { await loadTab(els.sheet.value); }
    catch (e) { setStatus(""); showError(e.message || String(e)); }
  })();
</script>
</body>
</html>
